<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementation of stacks &mdash; Forth virtual machine  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Forth virtual machine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../system_overview.html">System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forth.html">Forth overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fbuilder.html">FBuilder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virtual_machine.html">VM Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_decisions.html">Design decisions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Forth virtual machine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Implementation of stacks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/adr/adr03.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="implementation-of-stacks">
<h1>Implementation of stacks<a class="headerlink" href="#implementation-of-stacks" title="Permalink to this headline">¶</a></h1>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Creation date</strong></p></td>
<td><p>None</p></td>
</tr>
<tr class="row-even"><td><p><strong>Last update</strong></p></td>
<td><p>12.9.2023</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Status</strong></p></td>
<td><p>active</p></td>
</tr>
</tbody>
</table>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>Forth uses two different stacks, the data stack and the return stack. For these
stacks we need to provide corresponding memory somewhere and the stack pointers
need to be initialised correctly. According to the Forth specification (citation
needed) it is left to the implementation whether these stacks are in the same
memory as dictionaries, <cite>TIB</cite> etc. or whether they use a separate memory.</p>
<p>This allows for some freedoms in the implementation of such stacks in this
Forth VM.</p>
</div>
<div class="section" id="options">
<h2>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<div class="section" id="stacks-occupy-the-same-memory-as-all-other-data">
<h3>(1) Stacks occupy the same memory as all other data<a class="headerlink" href="#stacks-occupy-the-same-memory-as-all-other-data" title="Permalink to this headline">¶</a></h3>
<p>In this variant, the implementor of a Forth has to reserve space in the
data memory that is allocated to the corresponding stacks. Before the
first stack operation is performed, they also need to initialise the stack
pointers to point to a location inside this allocated memory.</p>
<p><strong>Advantages</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>The VM only needs one memory region that is used by everything in the
implementation.</p></li>
</ul>
</div></blockquote>
<p><strong>Disadvantages</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>The guiding idea of the VM was to allow for easy porting to different
target systems. However when the stacks are placed in the same memory
as the rest, required space and a location has to be assigned already
when implementing a Forth system. These decisions are then fixed when
doing the porting effort and are difficult to change.</p></li>
<li><p>Because the stacks first have to be initialised by VM code, the
debugger can’t easily determine where exactly the stack top/bottom is
located.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="stacks-are-placed-in-dedicated-memories">
<h3>(2) Stacks are placed in dedicated memories<a class="headerlink" href="#stacks-are-placed-in-dedicated-memories" title="Permalink to this headline">¶</a></h3>
<p>In this variant, the data and return stacks are handled through dedicated
memories. The stack pointers can simply be initialised to 0x0 and both
stacks can simply grow upwards without losing generality when porting.</p>
<p><strong>Advantages</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>No special stack initialisation is necessary.</p></li>
<li><p>Introspection into the stack gets easier for the debugger, because
stacks can always grow in the same direction and it clear from the
start, at what address the stack bottom is found.</p></li>
</ul>
</div></blockquote>
<p><strong>Disadvantages</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>From the Forth perspective, access to the stack has to be handled
through additional dedicated instructions.</p></li>
<li><p>Operations that access specific elements on the stack either require a
series of push and pop operations or additional, dedicated assembler
instructions.</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h2>
<p>The decision was made for the <strong>(2) stacks in dedicated memories</strong> solution.
The main reasons for this are the ease of stack handling from a debugging
and initialisation perspective and the better portability to different
target systems.</p>
<p>For access to the stack, dedicated push and pop operations are implemented
in the virtual machine.</p>
<p>The push and pop operations are only implemented in the cell-sized version.
When mixing byte- and cellsized operations on the stack, it could become
difficult to keep track of whether the current top element is a byte or a
word.</p>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Silvan Wegmann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>