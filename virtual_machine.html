<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VM Internals &mdash; Forth virtual machine  documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Design decisions" href="design_decisions.html" />
    <link rel="prev" title="FBuilder" href="fbuilder.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Forth virtual machine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="system_overview.html">System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="forth.html">Forth overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="fbuilder.html">FBuilder</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">VM Internals</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#system">System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instruction-set">Instruction set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#operand-types">Operand types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#encodings">Encodings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#add-add">ADD - Add</a></li>
<li class="toctree-l2"><a class="reference internal" href="#and-arithmetic-and">AND - Arithmetic and</a></li>
<li class="toctree-l2"><a class="reference internal" href="#call-call">CALL - Call</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ifkt-interface-functions">IFKT - Interface functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#illegal-illegal-instruction">ILLEGAL - Illegal instruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jc-jump-if-carry">JC - Jump if carry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jmp-jump-unconditionally">JMP - Jump unconditionally</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jz-jump-if-zero">JZ - Jump if zero</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mov-move">MOV - Move</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushd-popd-pushr-popr-stack-operations">PUSHD, POPD, PUSHR, POPR - Stack operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nop-no-operation">NOP - No Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#or-arithmetic-or">OR - Arithmetic or</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sra-shift-right-arithmetically">SRA - Shift Right Arithmetically</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sll-shift-left-logically">SLL - Shift Left Logically</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sub-subtract">SUB - Subtract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xor-arithmetic-exclusive-or">XOR - Arithmetic exclusive or</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="design_decisions.html">Design decisions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Forth virtual machine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>VM Internals</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/virtual_machine.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="vm-internals">
<h1>VM Internals<a class="headerlink" href="#vm-internals" title="Permalink to this headline">¶</a></h1>
<div class="section" id="system">
<h2>System<a class="headerlink" href="#system" title="Permalink to this headline">¶</a></h2>
<p>The virtual machine is a 32-bit, little endian, byte code interpreter. The guiding idea was to provide as few different instructions
as possible so that they can easily be mapped to real processor architectures. It contains a simple 32-bit integer arithmetic ALU, a
simple memory interface to access code and data memory, 8 32-bit registers and the carry flag.</p>
<p>TODO: concept of different possibilites for stack strategies</p>
<p>The following registers represent the state of the processor</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 5%" />
<col style="width: 95%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PC</p></td>
<td><p>Program Counter; This register points at the currently executed machine code.</p></td>
</tr>
<tr class="row-odd"><td><p>IP</p></td>
<td><p>Instruction Pointer;</p></td>
</tr>
<tr class="row-even"><td><p>WP</p></td>
<td><p>Word Pointer;</p></td>
</tr>
<tr class="row-odd"><td><p>RSP</p></td>
<td><p>Return Stack Pointer; This register implements the Forth return stack.</p></td>
</tr>
<tr class="row-even"><td><p>DSP</p></td>
<td><p>Data Stack Pointer; This register implements the Forth data stack.</p></td>
</tr>
<tr class="row-odd"><td><p>ACC1</p></td>
<td><p>Accumulator 1; This register is intended as a general purpose register for various calculations. The accumulator 1 is the only register that can be loaded from an immediate value.</p></td>
</tr>
<tr class="row-even"><td><p>ACC2</p></td>
<td><p>Accumulator 2;</p></td>
</tr>
<tr class="row-odd"><td><p>RET</p></td>
<td><p>Return Pointer; This register is used to store the address immediately following a call instruction.</p></td>
</tr>
<tr class="row-even"><td><p>Carry</p></td>
<td><p>The carry flag; This flag can only be affected by the arithmetic operations <code class="docutils literal notranslate"><span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">sub</span></code>.
The flag is used by the <code class="docutils literal notranslate"><span class="pre">jc</span></code> jump instruction to conditionally jump based on over- or underflow
in the last <code class="docutils literal notranslate"><span class="pre">add</span></code> or <code class="docutils literal notranslate"><span class="pre">sub</span></code> operation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="instruction-set">
<h2>Instruction set<a class="headerlink" href="#instruction-set" title="Permalink to this headline">¶</a></h2>
<p>The virtual machine implements a simple byte-code instruction set with variable amounts of parameters. The
instruction mnemonics, their encoding, possible parameters and the semantics are explained in this section.</p>
<div class="section" id="operand-types">
<h3>Operand types<a class="headerlink" href="#operand-types" title="Permalink to this headline">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Abbreviation</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>imm5</cite></p></td>
<td><p>5-bit immediate value</p></td>
</tr>
<tr class="row-odd"><td><p><cite>imm8</cite></p></td>
<td><p>8-bit immediate value</p></td>
</tr>
<tr class="row-even"><td><p><cite>imm16</cite></p></td>
<td><p>16-bit immediate value</p></td>
</tr>
<tr class="row-odd"><td><p><cite>imm32</cite></p></td>
<td><p>32-bit immediate value</p></td>
</tr>
<tr class="row-even"><td><p><cite>label</cite></p></td>
<td><p>32-bit jump target address</p></td>
</tr>
<tr class="row-odd"><td><p><cite>reg</cite></p></td>
<td><p>A register</p></td>
</tr>
<tr class="row-even"><td><p><cite>regi</cite></p></td>
<td><p>Register or register indirect expression</p></td>
</tr>
<tr class="row-odd"><td><p><cite>regi_op</cite></p></td>
<td><p>Register or register indirect expression with pre- or postfix operations</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="encodings">
<h3>Encodings<a class="headerlink" href="#encodings" title="Permalink to this headline">¶</a></h3>
<p>In most cases when registers need to be encoded in the opcodes, the following mapping is used.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 52%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Register</p></th>
<th class="head"><p>Encoding</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%ip</span></code></p></td>
<td><p>0x0</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%wp</span></code></p></td>
<td><p>0x1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%rsp</span></code></p></td>
<td><p>0x2</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%dsp</span></code></p></td>
<td><p>0x3</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%acc1</span></code></p></td>
<td><p>0x4</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%acc2</span></code></p></td>
<td><p>0x5</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%ret</span></code></p></td>
<td><p>0x6</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%pc</span></code></p></td>
<td><p>0x7</p></td>
</tr>
</tbody>
</table>
<p>All number types comprising of more than one byte are stored in little-endian format.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Encoding</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">u16</span></code></p></td>
<td><p>A 16-bit unsigned integer value in little-endian encoding</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">u32</span></code></p></td>
<td><p>A 32-bit unsigned integer value in little-endian encoding</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reg</span></code></p></td>
<td><p>A register as encoded above; This encoding is only used as part
in encodings and therefore doesn’t have a specified bit length</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">rr</span></code></p></td>
<td>
<div style="overflow-x:auto">
<script type="WaveDrom">
{
    "reg": [
        { "name": "reg_src", "bits": 3 },
        { "name": "DI_S",    "bits": 1 },
        { "name": "reg_tgt", "bits": 3 },
        { "name": "DI_T",    "bits": 1 }
    ],
    "config": {
        "hspace": 300
    }
}

</script>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DI_T</span></code> Flag to indicate whether the target register is used
direct or indirect. A <code class="docutils literal notranslate"><span class="pre">1</span></code> means indirect.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code> The target register encoded as described above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DI_S</span></code> Flag to indicate whether the source register is used
direct or indirect. A <code class="docutils literal notranslate"><span class="pre">1</span></code> means indirect.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_src</span></code> The source register encoded as described above.</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">3r</span></code></p></td>
<td>
<div style="overflow-x:auto">
<script type="WaveDrom">
{
    "reg": [
        { "name": "reg_src2", "bits": 3 },
        {                     "bits": 5 },
        { "name": "reg_src1", "bits": 3 },
        {                     "bits": 1 },
        { "name": "reg_tgt",  "bits": 3 },
        {                     "bits": 1 }
    ],
    "config": {
        "lanes": 2,
        "hspace": 450
    }
}

</script>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code> The target register encoded as described above</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> The first source register encoded as described above</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> The second source register encoded as described above</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">rop</span></code></p></td>
<td>
<div style="overflow-x:auto">
<script type="WaveDrom">
{
    "reg": [
        { "name": "reg_src", "bits": 3 },
        { "name": "reg_tgt", "bits": 3 },
        { "name": "PP",      "bits": 1 },
        { "name": "DI",      "bits": 1 }
    ],
    "config": {
        "hspace": 300
    }
}

</script>
</div>
<p>This encoding describes an instruction where either the source or
the target register is used in an indirect mode and is additionally
affected by an increment- or decrement operation. Which register is
used this way, depends on the actual machine instruction.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DI</span></code> Flag to indicate what operation is to be performed on the
affected register. A <code class="docutils literal notranslate"><span class="pre">1</span></code> means decrement, <code class="docutils literal notranslate"><span class="pre">0</span></code> means increment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PP</span></code> Flag to indicate whether the operation is performed before
indirectly accessing memory or after. A <code class="docutils literal notranslate"><span class="pre">1</span></code> means pre operation,
a <code class="docutils literal notranslate"><span class="pre">0</span></code> means post operation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code> The register encoded as described above, used as target
indication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reg_src</span></code> The register encoded as described above, used as source
indication.</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ri5</span></code></p></td>
<td>
<div style="overflow-x:auto">
<script type="WaveDrom">
{
    "reg": [
        { "name": "val5", "bits": 5 },
        { "name": "reg",  "bits": 3 }
    ],
    "config": {
        "hspace": 300
    }
}
</script>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reg</span></code> The affected register encoded as described above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">val5</span></code> A 5-bit immediate value.</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="add-add">
<h2>ADD - Add<a class="headerlink" href="#add-add" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>30 <cite>/3r</cite></p></td>
<td><p>ADD <cite>reg_tgt</cite>, <cite>reg_src1</cite>, <cite>reg_src2</cite></p></td>
<td><p>Add values in registers</p></td>
</tr>
</tbody>
</table>
<p>This instruction adds the registers <code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> and <code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> together and stores
the result in the register <code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code>. The addition is performed unsigned.</p>
<p>In case of overflows, the carry flag is set. Otherwise the carry flag is cleared.</p>
</div>
<div class="section" id="and-arithmetic-and">
<h2>AND - Arithmetic and<a class="headerlink" href="#and-arithmetic-and" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>36 <cite>/3r</cite></p></td>
<td><p>AND <cite>reg_tgt</cite>, <cite>reg_src1</cite>, <cite>reg_src2</cite></p></td>
<td><p>and arithmetically values in registers</p></td>
</tr>
</tbody>
</table>
<p>This instruction ands <code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> with <code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> and stores the result in
register <code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code>. The and is performed arithmetically and thus the bits are
affected individually.</p>
</div>
<div class="section" id="call-call">
<h2>CALL - Call<a class="headerlink" href="#call-call" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>73 <cite>/u32</cite></p></td>
<td><p>CALL <cite>label</cite></p></td>
<td><p>Jump to immediate address and store the
following address in the <code class="docutils literal notranslate"><span class="pre">%ret</span></code> register.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ifkt-interface-functions">
<h2>IFKT - Interface functions<a class="headerlink" href="#ifkt-interface-functions" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FE <cite>/u16</cite></p></td>
<td><p>IFKT <cite>imm16</cite></p></td>
<td><p>Calling virtual machine interface functions</p></td>
</tr>
</tbody>
</table>
<p>Allows calling certain functions special to the virtual machine.</p>
<p>The virtual machine currently supports the following interface functions.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 20%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Short Name</p></th>
<th class="head"><p>Function description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x01</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">INPUT</span></code></p></td>
<td><p>Read one character from the keyboard and store the
ASCII code in the <code class="docutils literal notranslate"><span class="pre">%acc1`</span></code> register.</p></td>
</tr>
<tr class="row-odd"><td><p>0x02</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code></p></td>
<td><p>Using the byte value at the least significant
position in register <code class="docutils literal notranslate"><span class="pre">%acc1</span></code>, print one character.</p></td>
</tr>
<tr class="row-even"><td><p>0xF0</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">TERMINATE</span></code></p></td>
<td><p>Terminate the virtual machine.</p></td>
</tr>
<tr class="row-odd"><td><p>0xF2</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">DUMP_M</span></code></p></td>
<td><p>Dump all values between the addresses specified in
the registers <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> and <code class="docutils literal notranslate"><span class="pre">%acc2</span></code>. The beginning
address is also dumped but not the ending. The values
will always be dumped in the order from the smaller
address to the larger, no matter in what register
they are stored.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="illegal-illegal-instruction">
<h2>ILLEGAL - Illegal instruction<a class="headerlink" href="#illegal-illegal-instruction" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FF</p></td>
<td><p>ILLEGAL</p></td>
<td><p>Illegal instruction</p></td>
</tr>
</tbody>
</table>
<p>In general any instruction not explicitly defined is considered to be an
illegal instruction and causes the VM to abort interpretation. However for test
purposes, the mnemonic <code class="docutils literal notranslate"><span class="pre">illegal</span></code> and the opcode <code class="docutils literal notranslate"><span class="pre">0xFF</span></code> are explicitly
declared to be illegal instructions and shall remain so even with future
instruction set extensions.</p>
</div>
<div class="section" id="jc-jump-if-carry">
<h2>JC - Jump if carry<a class="headerlink" href="#jc-jump-if-carry" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>72 <cite>/u32</cite></p></td>
<td><p>JC <cite>label</cite></p></td>
<td><p>Jump to immediate address when carry flag is set</p></td>
</tr>
</tbody>
</table>
<p>The carry flag can only be set and cleared by performing an <code class="docutils literal notranslate"><span class="pre">add</span></code> or <code class="docutils literal notranslate"><span class="pre">sub</span></code>
instruction. The <code class="docutils literal notranslate"><span class="pre">jc</span></code> instruction jumps to an immediate address when this carry
flag is set.</p>
</div>
<div class="section" id="jmp-jump-unconditionally">
<h2>JMP - Jump unconditionally<a class="headerlink" href="#jmp-jump-unconditionally" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>60 + <cite>/reg</cite></p></td>
<td><p>JMP [<cite>reg</cite>]</p></td>
<td><p>Jump to register indirect</p></td>
</tr>
<tr class="row-odd"><td><p>68 + <cite>/reg</cite></p></td>
<td><p>JMP <cite>reg</cite></p></td>
<td><p>Jump to register direct</p></td>
</tr>
<tr class="row-even"><td><p>70 <cite>/u32</cite></p></td>
<td><p>JMP <cite>label</cite></p></td>
<td><p>Jump to immediate address</p></td>
</tr>
</tbody>
</table>
<p>The register indirect jump instructions will use the register content to read a
32-bit value from the memory. Then execution jumps to the address given by this
32-bit value. Any one of the known registers can serve as register indirect
source. In case of the <code class="docutils literal notranslate"><span class="pre">%pc</span></code> register this may not have any meaningful purpose.</p>
<p>The register direct jump instruction will directly jump to the 32-bit address
location specified in the given register. Any one of the known registers can serve
as the register direct source.</p>
<p>The immediate address jump instruction will jump directly to the 32-bit immediate
value given as the operand of the instruction.</p>
</div>
<div class="section" id="jz-jump-if-zero">
<h2>JZ - Jump if zero<a class="headerlink" href="#jz-jump-if-zero" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>71 <cite>/u32</cite></p></td>
<td><p>JZ <cite>label</cite></p></td>
<td><p>Jump to immediate address when <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> is zero</p></td>
</tr>
</tbody>
</table>
<p>With <code class="docutils literal notranslate"><span class="pre">jz</span></code> a jump to an immediate address is performed if the value of the
accumulator register <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> has the value <code class="docutils literal notranslate"><span class="pre">0x0</span></code>.</p>
</div>
<div class="section" id="mov-move">
<h2>MOV - Move<a class="headerlink" href="#mov-move" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>20 <cite>/rr</cite></p></td>
<td><p>MOV.W <cite>regi</cite>, <cite>regi</cite></p></td>
<td><p>Move register to register word sized</p></td>
</tr>
<tr class="row-odd"><td><p>21 <cite>/rr</cite></p></td>
<td><p>MOV.B <cite>regi</cite>, <cite>regi</cite></p></td>
<td><p>Move register to register byte sized</p></td>
</tr>
<tr class="row-even"><td><p>22 <cite>/rop</cite></p></td>
<td><p>MOV.W <cite>regi_op</cite>, <cite>reg</cite></p></td>
<td><p>Move register to register indirect memory with operation word sized</p></td>
</tr>
<tr class="row-odd"><td><p>23 <cite>/rop</cite></p></td>
<td><p>MOV.B <cite>regi_op</cite>, <cite>reg</cite></p></td>
<td><p>Move register to register indirect memory with operation byte sized</p></td>
</tr>
<tr class="row-even"><td><p>24 <cite>/rop</cite></p></td>
<td><p>MOV.W <cite>reg</cite>, <cite>regi_op</cite></p></td>
<td><p>Move register indirect memory to register with operation word sized</p></td>
</tr>
<tr class="row-odd"><td><p>25 <cite>/rop</cite></p></td>
<td><p>MOV.B <cite>reg</cite>, <cite>regi_op</cite></p></td>
<td><p>Move register indirect memory to register with operation byte sized</p></td>
</tr>
<tr class="row-even"><td><p>26 <cite>/u32</cite></p></td>
<td><p>MOV.W %acc1, <cite>imm32</cite></p></td>
<td><p>Move an immediate 32-bit value to register acc1</p></td>
</tr>
<tr class="row-odd"><td><p>27 <cite>/u32</cite></p></td>
<td><p>MOV.W %acc2, <cite>imm32</cite></p></td>
<td><p>Move an immediate 32-bit value to register acc2</p></td>
</tr>
</tbody>
</table>
<p>The virtual machine supports three different types of move operations.</p>
<p>The first type of move operations supports registers and register-indexed memory
locations. All registers and combinations of register and register-indexing are
supported. For example in the following instruction</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MOV</span><span class="o">.</span><span class="n">W</span> <span class="p">[</span><span class="o">%</span><span class="n">acc1</span><span class="p">],</span> <span class="o">%</span><span class="n">wp</span>
</pre></div>
</div>
<p>the content of register <code class="docutils literal notranslate"><span class="pre">%wp</span></code> is stored into the memory location specified by
the <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> register.</p>
<p>For this type of move operations, byte-sized and word-sized moves are supported.
In case of byte-sized moves, only the least significant byte of the 32-bit register
is stored in memory or read from memory.</p>
<p>The second type of move operations are either a move operation from a register to
a register-indexed memory location or from a register-indexed memory to a register.
However the register used for the memory access will additionally be changed by
either incrementing or decrementing, either before or after accessing the memory.
For example in the following instruction</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MOV</span><span class="o">.</span><span class="n">W</span> <span class="p">[</span><span class="o">%</span><span class="n">dsp</span><span class="o">++</span><span class="p">],</span> <span class="o">%</span><span class="n">acc1</span>
</pre></div>
</div>
<p>the content of register <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> is stored in the memory location specified by
the <code class="docutils literal notranslate"><span class="pre">%dsp</span></code> register. After storing the value, the value of the <code class="docutils literal notranslate"><span class="pre">%dsp</span></code> register
is incremented by <code class="docutils literal notranslate"><span class="pre">4</span></code> to point to the next word in memory. These registers are
meant for pushing register values onto stacks and popping them again. When Using
the byte sized variant of these instructions, the registers for accessing the
memory are only incremented or decremented by 1.</p>
<p>For the third type of move operations, only the <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> and <code class="docutils literal notranslate"><span class="pre">%acc2</span></code> registers
can be used. It allows for loading immediate 32-bit values into the registers. For
example in the following instruction</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MOV</span><span class="o">.</span><span class="n">W</span> <span class="o">%</span><span class="n">acc1</span><span class="p">,</span> <span class="c1">#0x12345678</span>
</pre></div>
</div>
<p>the immediate value <code class="docutils literal notranslate"><span class="pre">0x12345678</span></code> is stored into the <code class="docutils literal notranslate"><span class="pre">%acc1</span></code> register.</p>
</div>
<div class="section" id="pushd-popd-pushr-popr-stack-operations">
<h2>PUSHD, POPD, PUSHR, POPR - Stack operations<a class="headerlink" href="#pushd-popd-pushr-popr-stack-operations" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A0 + <cite>/reg</cite></p></td>
<td><p>PUSHD <cite>regi</cite></p></td>
<td><p>Push register to the data stack</p></td>
</tr>
<tr class="row-odd"><td><p>A8 + <cite>/reg</cite></p></td>
<td><p>POPD <cite>regi</cite></p></td>
<td><p>Pop top of data stack into register</p></td>
</tr>
<tr class="row-even"><td><p>B0 + <cite>/reg</cite></p></td>
<td><p>PUSHR <cite>regi</cite></p></td>
<td><p>Push register to the return stack</p></td>
</tr>
<tr class="row-odd"><td><p>B8 + <cite>/reg</cite></p></td>
<td><p>POPR <cite>regi</cite></p></td>
<td><p>Pop top of return stack into register</p></td>
</tr>
</tbody>
</table>
<p>The virtual machine features two separate memory regions for the data and return
stacks. Data is moved to and form these stacks using <cite>push</cite> and <cite>pop</cite> instructions.
The related stack (data or return) is indicated by a one-letter suffix on the
corresponding instructions - a <cite>d</cite> for the data stack, an <cite>r</cite> for the return stack.
Stack operations only support 32-bit values.</p>
</div>
<div class="section" id="nop-no-operation">
<h2>NOP - No Operation<a class="headerlink" href="#nop-no-operation" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>00</p></td>
<td><p>NOP</p></td>
<td><p>No operation</p></td>
</tr>
</tbody>
</table>
<p>This instruction has no effect and can be used to fill memory.</p>
</div>
<div class="section" id="or-arithmetic-or">
<h2>OR - Arithmetic or<a class="headerlink" href="#or-arithmetic-or" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>34 <cite>/3r</cite></p></td>
<td><p>OR <cite>reg_tgt</cite>, <cite>reg_src1</cite>, <cite>reg_src2</cite></p></td>
<td><p>or arithmetically values in registers</p></td>
</tr>
</tbody>
</table>
<p>This instruction ors <code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> with <code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> and stores the result in
register <code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code>. The or is performed arithmetically and thus the bits are
affected individually.</p>
</div>
<div class="section" id="sra-shift-right-arithmetically">
<h2>SRA - Shift Right Arithmetically<a class="headerlink" href="#sra-shift-right-arithmetically" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>3C <cite>/ri5</cite></p></td>
<td><p>SRA.W <cite>reg</cite>, <cite>imm5</cite></p></td>
<td><p>Arithmetically shift the given register right by the given amount</p></td>
</tr>
</tbody>
</table>
<p>Shift the given register arithmetically right by the given 5-bit immediate value.
It shifts the most significant bit, number 31, into the following less significant
bits.</p>
</div>
<div class="section" id="sll-shift-left-logically">
<h2>SLL - Shift Left Logically<a class="headerlink" href="#sll-shift-left-logically" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>3E <cite>/ri5</cite></p></td>
<td><p>SLL.W <cite>reg</cite>, <cite>imm5</cite></p></td>
<td><p>Logically shift the given register left by the given amount</p></td>
</tr>
</tbody>
</table>
<p>Shift the given register logically left by the given 5-bit immediate value.</p>
</div>
<div class="section" id="sub-subtract">
<h2>SUB - Subtract<a class="headerlink" href="#sub-subtract" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>32 <cite>/3r</cite></p></td>
<td><p>SUB <cite>reg_tgt</cite>, <cite>reg_src1</cite>, <cite>reg_src2</cite></p></td>
<td><p>Subtract values in registers</p></td>
</tr>
</tbody>
</table>
<p>This instruction subtracts <code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> from <code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> and stores the result in
register <code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code>. The subtraction is performed unsigned.</p>
<p>In case of underflows, the carry flag is set. Otherwise the carry flag is cleared.</p>
</div>
<div class="section" id="xor-arithmetic-exclusive-or">
<h2>XOR - Arithmetic exclusive or<a class="headerlink" href="#xor-arithmetic-exclusive-or" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 23%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opcode</p></th>
<th class="head"><p>Mnemonic</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>38 <cite>/3r</cite></p></td>
<td><p>XOR <cite>reg_tgt</cite>, <cite>reg_src1</cite>, <cite>reg_src2</cite></p></td>
<td><p>exclusive or arithmetically values in registers</p></td>
</tr>
</tbody>
</table>
<p>This instruction xors <code class="docutils literal notranslate"><span class="pre">reg_src1</span></code> with <code class="docutils literal notranslate"><span class="pre">reg_src2</span></code> and stores the result in
register <code class="docutils literal notranslate"><span class="pre">reg_tgt</span></code>. The xor is performed arithmetically and thus the bits are
affected individually.</p>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fbuilder.html" class="btn btn-neutral float-left" title="FBuilder" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="design_decisions.html" class="btn btn-neutral float-right" title="Design decisions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Silvan Wegmann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>